TODO:
- diagnostic: don't break the diagnostic_cache with the current line
  virtual_text stuff. See the FIXME comment.
